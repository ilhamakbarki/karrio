# Karrio CLI Tools

Command-line utilities for Karrio carrier integration development.

## Installation

The CLI tools are included in the main Karrio installation. You can access them using the `kcli` or `karrio_cli` command.

```bash
# Install dependencies
pip install typer rich

# Use the CLI
./bin/kcli --help
```

## Features

-   Interactive command-line interface with helpful prompts
-   Tools for carrier integration management
-   Tools for plugin development
-   SDK utilities
-   Documentation generation

## Available Commands

For a full list of available commands, run:

```bash
kcli --help
```

## Interactive Usage

The CLI now supports interactive prompts when parameters are not provided, making it more user-friendly:

```bash
# Run in interactive mode
kcli create-plugin

# Run with explicit parameters
kcli create-plugin --plugin-name my-plugin --display-name "My Plugin"
```

You can disable interactive prompts by using the `--no-prompt` flag:

```bash
kcli create-carrier --carrier-name mycarrier --display-name "My Carrier" --no-prompt
```

## Common Commands

### Carrier Management

```bash
# Create a new carrier integration
kcli create-carrier

# Add a new carrier extension
kcli add-extension

# Troubleshoot carrier integrations
kcli troubleshoot

# Run tests for carrier integrations
kcli run-tests
```

### Plugin Management

Plugins are modular extensions that add functionality to Karrio without modifying the core code. You can create and manage plugins using the CLI:

```bash
# Create a new plugin (interactive)
kcli create-plugin
```

The interactive CLI will prompt you for all required information, including:

-   Plugin name
-   Display name
-   Description
-   Author information
-   Version
-   Carrier integration (if needed)

Once created, your plugin will have a complete structure with:

-   README.md and documentation
-   setup.py for package management
-   Core plugin implementation files
-   Carrier-specific integration (if specified)
-   Test framework

### Testing Your Plugin

After creating a plugin, you can test it using:

```bash
# Run tests on a specific plugin
python -m unittest discover -v plugins/your_plugin_name/tests
```

### Installing Your Plugin

To install your plugin in development mode:

```bash
pip install -e ./plugins/your_plugin_name
```

## Advanced Plugin Development

For detailed information about plugin development, including:

-   What plugins are and how they work
-   Plugin architecture and structure
-   Creating custom plugins step-by-step
-   Authentication methods
-   Custom carrier configuration
-   Advanced request serialization

See the [detailed plugin documentation](./docs/CLI_IMPROVEMENTS.md#understanding-karrio-plugins).

## Codegen

The `codegen` command provides utilities for code generation, particularly for transforming JSON schemas into Python code using jstruct.

### Transform

The `transform` command converts Python code generated by quicktype (using dataclasses) into code that uses attrs and jstruct decorators.

```bash
# Transform from stdin to stdout
cat input.py | karrio codegen transform > output.py

# Transform from file to file
karrio codegen transform input.py output.py

# Transform from file to stdout
karrio codegen transform input.py

# Disable appending 'Type' to class names
karrio codegen transform input.py output.py --no-append-type-suffix
```

The transform command makes the following changes:

-   Replaces `from dataclasses import dataclass` with explicit imports: `import attr`, `import jstruct`, `import typing`
-   Removes any `from typing import ...` lines entirely
-   Replaces `@dataclass` with `@attr.s(auto_attribs=True)`
-   Appends 'Type' to all class names (unless they already end with 'Type') by default
-   Replaces complex type annotations with jstruct equivalents
-   Ensures there are no duplicate import statements

### Generate

The `generate` command generates Python code with jstruct from a JSON schema file using quicktype.

```bash
# Generate Python code with jstruct from a JSON schema
karrio codegen generate --src=schema.json --out=output.py

# Specify Python version
karrio codegen generate --src=schema.json --out=output.py --python-version=3.8

# Generate without --just-types
karrio codegen generate --src=schema.json --out=output.py --just-types=false

# Disable appending 'Type' to class names
karrio codegen generate --src=schema.json --out=output.py --no-append-type-suffix
```

### Create Tree

The `create-tree` command generates a Python code tree from a class definition. It's useful for visualizing the structure of complex nested objects and generating initialization code templates.

```bash
# Generate a tree for a class
karrio codegen create-tree --module=karrio.schemas.allied_express.label_request --class-name=LabelRequest

# Generate a tree with a module alias
karrio codegen create-tree --module=karrio.schemas.allied_express.label_request --class-name=LabelRequest --module-alias=allied
```

Example output:

```python
LabelRequestType(
    bookedBy=None,
    account=None,
    instructions=None,
    itemCount=None,
    items=[
        ItemType(
            dangerous=None,
            height=None,
            itemCount=None,
            length=None,
            volume=None,
            weight=None,
            width=None,
        )
    ],
    jobStopsP=JobStopsType(
        companyName=None,
        contact=None,
        emailAddress=None,
        geographicAddress=GeographicAddressType(
            address1=None,
            address2=None,
            country=None,
            postCode=None,
            state=None,
            suburb=None,
        ),
        phoneNumber=None,
    ),
    jobStopsD=JobStopsType(...),
    referenceNumbers=[],
    serviceLevel=None,
    volume=None,
    weight=None,
)
```

## Migrating carrier connector generate scripts

To migrate carrier connector generate scripts to use the new codegen command, run:

```bash
python karrio/modules/cli/commands/migrate_generate_scripts.py /path/to/karrio/workspace
```

This will update all generate scripts in the carrier connectors to use the new karrio codegen command.

## JStruct Overview

JStruct is a Python library for nested object models that offers serialization and deserialization into Python dictionaries. It leverages the `attrs` library to define structs without boilerplate.

Here's an example of the transformed code:

```python
import attr
import jstruct
import typing

@attr.s(auto_attribs=True)
class PersonType:
    first_name: typing.Optional[str] = None
    last_name: typing.Optional[str] = None

@attr.s(auto_attribs=True)
class RoleModelsType:
    scientists: typing.Optional[typing.List[PersonType]] = jstruct.JList[PersonType]
```

For more information, see the [JStruct README](https://github.com/karrioapi/jstruct/blob/main/README.md).
